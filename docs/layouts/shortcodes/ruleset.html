
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js">
</script>

<div class="input-group">
  <input type="text" id="myInput" onkeyup="doSearch()"
         class="form-control"
         placeholder="Search rules"
         aria-describedby="basic-addon2">
  <span class="input-group-addon"
        id="basic-addon2"><i class="fas fa-search"></i></span>
</div>

<hr />

<div class="search_results"></div>

<script>
let all_data = [];

$.ajax({
    url: {{ .Get 0 }},
}).done(function( data ) {
  all_data = data;
  DrawResults(data);
});

function matchItem(filter, item) {
    if (item.title.toUpperCase().includes(filter) ||
        item.description.toUpperCase().includes(filter)) {
        return true;
    }

    let labels = item.tags || [];
    for(let j=0;j<labels.length;j++) {
        if (labels[j].toUpperCase().includes(filter)) {
            return true;
        }
    }
    return false;
}

function insertRule(node, link) {
    let existing = node.find("pre");
    if (existing.length > 0) {
        existing.remove();
        return;
    }

    $.ajax({
        url: link,
        method: "GET",
        success: function(data) {
            let highlighted = hljs.highlight(data, {language: "yaml"});
            let new_node = $("<pre>").append($("<code>").append(highlighted.value));
            node.append(new_node);
        }
    });
}

function doSearch() {
  // Declare variables
  let input = document.getElementById('myInput');
  let filter = input.value.toUpperCase();

  let result = [];
  for(let i=0;i<all_data.length; i++) {
      let item = all_data[i];
      if (matchItem(filter, item)) {
          result.push(item);
      };
      if (result.length > 50) {
          break;
      }
  };
  DrawResults(result);
}

// Only show up to 50 hits to make the page load faster.
function DrawResults(data) {
    $(".search_results").empty();

    let most_results = data.length;
    if(most_results > 50) {
        most_results = 50;
    }

  for(let i=0;i<most_results; i++) {
      let item = data[i];
      let template = $(`
<div class="panel panel-default color">
  <div class="panel-heading color">
    <a class="title" target="new" href=""><h3 class="panel-title color " ></h3></a>
    <div class="author pull-right"></div>
  </div>
  <div class="panel-body color">
    <div class="border color">
       <div class="border color">
         <div class="idea-inner-text-main color">
           <p class="description "></p>
           <p class="idea-tag space"></p>
         </div>
       </div>
    </div>
</div>`);

      template.find(".title").append(item.title);
      template.find(".author").append(item.author);
      template.find(".description").append(item.description);
      template.find(".title").attr("href", item.link).click(function() {
          insertRule(template, item.link);
          return false;
      });
      template.find(".date").append(item.date)

    let labels = item.tags || [];
    for (let j=0; j<labels.length; j++) {
        let tag = labels[j];
        let link = $(`
<a class="space tag"><i class="linkcolour label label-success">` +
                     tag + `</i></a>`).click(function() {
                         document.getElementById('myInput').value = tag;
                         doSearch();
                     });
        template.find(".idea-tag").append(link);
    }
    let new_item = $(".search_results").append(template);
  }
};

function myFunction() {
  // Declare variables
  var input, filter, ul, li, a, i, txtValue;
  input = document.getElementById('myInput');
  filter = input.value.toUpperCase();
  ul = document.getElementById("myUL");
    li = ul.getElementsByTagName('li');

  // Loop through all list items, and hide those who don't match the
  // search query
  for (i = 0; i < li.length; i++) {
    a = li[i].getElementsByTagName("a")[0];
    txtValue = a.textContent || a.innerText;

    if (txtValue.toUpperCase().indexOf(filter) > -1) {
      li[i].style.display = "";
    } else {
      li[i].style.display = "none";
    }
  }
}
</script>
