<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Windows Base ETW Model
  #

This model is designed to follow ETW event sources.
ETW events are provided by various ETW Providers in the Windows
Kernel. These events can provide security critical information which
can be detected using Sigma Rules.
This is a real time monitoring profile which allows live monitoring
of Windows systems using Sigma rules.

  Log Sources
  #

Following is a list of recognized log sources."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://sigma.velocidex.com/docs/models/windows_etw_base/"><meta property="og:site_name" content="Velociraptor Curated Sigma"><meta property="og:title" content="Velociraptor Curated Sigma"><meta property="og:description" content="Windows Base ETW Model # This model is designed to follow ETW event sources.
ETW events are provided by various ETW Providers in the Windows Kernel. These events can provide security critical information which can be detected using Sigma Rules.
This is a real time monitoring profile which allows live monitoring of Windows systems using Sigma rules.
Log Sources # Following is a list of recognized log sources."><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><title>&lt;span class="icon">
&lt;i class="fa-solid fa-book">&lt;/i>
Windows Etw Base
&lt;/span> | Velociraptor Curated Sigma</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=http://sigma.velocidex.com/docs/models/windows_etw_base/><link rel=stylesheet href=/book.min.3257a7ce7c061eb5dfc72257c356229b1470dc77ce9b982ac220c02542f9f04f.css integrity="sha256-MlenznwGHrXfxyJXw1YimxRw3HfOm5gqwiDAJUL58E8=" crossorigin=anonymous><link rel=alternate type=application/rss+xml href=http://sigma.velocidex.com/docs/models/windows_etw_base/index.xml title="Velociraptor Curated Sigma"><script src=/js/jquery-3.3.1.min.js?1703133391></script><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1703133392 rel=stylesheet><link href=/css/theme.css rel=stylesheet><link href=//cdn.datatables.net/2.3.0/css/dataTables.dataTables.min.css rel=stylesheet><script src=//cdn.datatables.net/2.3.0/js/dataTables.min.js></script><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/yaml.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/featherlight/1.7.13/featherlight.min.js integrity="sha512-0UbR6HN0dY8fWN9T7fF658896tsPgnbRREHCNq46J9/JSn8GonXDZmqtTc3qS879GM0zV49b9LPhdc/maKP8Kg==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/featherlight/1.7.13/featherlight.min.css integrity="sha512-56GJrpSgHk6Mc9Fltt+bQKcICJoEpxtvozXPA5n5OT0rfWiqGlJmJCI/vl16kctf/0XbBloh03vl7OF2xFnR8g==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css rel=stylesheet><script>$(document).ready(function(){$(".json-renderer").each(function(){try{data=JSON.parse($(this).text()),$(this).jsonViewer(data,{collapsed:!0,rootCollapsable:!1})}catch{}}),$(".datatable").each(function(){new DataTable(this,{paging:!0})}),$(".scroll-datatable").each(function(){let e=$(this),t=new DataTable(this,{paging:!1,scrollY:200})})})</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Velociraptor Curated Sigma</span></a></h2><ul><li><a href=/docs/sigma_in_velociraptor/><span class=icon><i class="fa-solid fa-blog"></i>
Sigma In Velociraptor</span></a><ul><li><a href=/docs/sigma_in_velociraptor/customize/>Customizing Artifacts</a><ul></ul></li></ul></li><li><a href=/docs/artifacts/><span class=icon><i class="fa-solid fa-desktop"></i>
Velociraptor Artifacts</span></a><ul><li><a href=/docs/artifacts/linux.ebpf.monitoring/><span class=icon><i class="fa-solid fa-book"></i>
Linux.EBPF.Monitoring</span></a><ul></ul></li><li><a href=/docs/artifacts/linux.sigma.triage/><span class=icon><i class="fa-solid fa-book"></i>
Linux.Sigma.Triage</span></a><ul></ul></li><li><a href=/docs/artifacts/windows.etw.monitoring/><span class=icon><i class="fa-solid fa-book"></i>
Windows.ETW.Monitoring</span></a><ul></ul></li><li><a href=/docs/artifacts/windows.hayabusa.monitoring/><span class=icon><i class="fa-solid fa-book"></i>
Windows.Hayabusa.Monitoring</span></a><ul></ul></li><li><a href=/docs/artifacts/windows.hayabusa.rules/><span class=icon><i class="fa-solid fa-book"></i>
Windows.Hayabusa.Rules</span></a><ul></ul></li><li><a href=/docs/artifacts/windows.sigma.triage/><span class=icon><i class="fa-solid fa-book"></i>
Windows.Sigma.Triage</span></a><ul></ul></li></ul></li><li><a href=/docs/models/><span class=icon><i class="fa-solid fa-desktop"></i>
Sigma Models</span></a><ul><li><a href=/docs/models/linux_base/><span class=icon><i class="fa-solid fa-book"></i>
Linux Base</span></a><ul></ul></li><li><a href=/docs/models/linux_ebpf_base/><span class=icon><i class="fa-solid fa-book"></i>
Linux Ebpf Base</span></a><ul></ul></li><li><a href=/docs/models/windows_base/><span class=icon><i class="fa-solid fa-book"></i>
Windows Base</span></a><ul></ul></li><li><a href=/docs/models/windows_base_events/><span class=icon><i class="fa-solid fa-book"></i>
Windows Base Events</span></a><ul></ul></li><li><a href=/docs/models/windows_base_vql/><span class=icon><i class="fa-solid fa-book"></i>
Windows Base Vql</span></a><ul></ul></li><li><a href=/docs/models/windows_etw_base/ class=active><span class=icon><i class="fa-solid fa-book"></i>
Windows Etw Base</span></a><ul></ul></li></ul></li><li><a href=/docs/github/><span class=icon><i class="fa-brands fa-github"></i>
Github</span></a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3><span class=icon><i class="fa-solid fa-book"></i>
Windows Etw Base</span></h3><label for=toc-control></label></div></header><article class="markdown book-article"><h1 id=windows-base-etw-model>Windows Base ETW Model
<a class=anchor href=#windows-base-etw-model>#</a></h1><p>This model is designed to follow ETW event sources.</p><p>ETW events are provided by various ETW Providers in the Windows
Kernel. These events can provide security critical information which
can be detected using Sigma Rules.</p><p>This is a real time monitoring profile which allows live monitoring
of Windows systems using Sigma rules.</p><h2 id=log-sources>Log Sources
<a class=anchor href=#log-sources>#</a></h2><p>Following is a list of recognized log sources.</p><table class=scroll-datatable><thead><tr><th>Log Source</th><th>Desc</th></tr></thead><tbody><tr><td><a href=#etwwindowskernel>etw/windows/kernel</a></td><td>Events from the `NT Kernel Logger` provider</td></tr><tr><td><a href=#etwwindowsfile>etw/windows/file</a></td><td>Log source based on the `Microsoft-Windows-Kernel-File` provider.</td></tr><tr><td><a href=#etwwindowsregistry>etw/windows/registry</a></td><td>Log source based on the `Microsoft-Windows-Kernel-Registry` provider.</td></tr><tr><td><a href=#etwwindowsprocess>etw/windows/process</a></td><td>Log source based on the `Microsoft-Windows-Kernel-Registry` provider</td></tr><tr><td><a href=#etwwindowssysmon>etw/windows/sysmon</a></td><td>Log source to read Sysmon events via ETW</td></tr><tr><td><a href=#etwwindowsetw>etw/windows/etw</a></td><td>Log source to monitor ETW system states</td></tr><tr><td><a href=#etwwindowswmi>etw/windows/wmi</a></td><td>Log source to monitor WMI activity</td></tr><tr><td><a href=#etwwindowsdns>etw/windows/dns</a></td><td>Log source to monitor DNS Lookups</td></tr></tbody></table><h2 id=field-mappings>Field Mappings
<a class=anchor href=#field-mappings>#</a></h2><p>The following field mappings can be used to access fields within the
event. Note that it is also possible to access the fields directly
(e.g. <code>EventData.AccessMask</code>)</p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>View all Field Mappings</span></div><div class=expand-content style=display:none><table class=datatable><thead><tr><th>Name</th><th>Mapping</th></tr></thead><tbody><tr><td>Channel</td><td>x=>x.System.Channel</td></tr><tr><td>CommandLine</td><td>x=>x.EventData.ProcInfo.CommandLine</td></tr><tr><td>Computer</td><td>x=>x.System.Computer</td></tr><tr><td>EventType</td><td>x=>x.System.EventType</td></tr><tr><td>FileName</td><td>x=>x.EventData.FileName || x.EventData.OpenPath</td></tr><tr><td>KeyName</td><td>x=>x.EventData.KeyName</td></tr><tr><td>Offset</td><td>x=>int(int=x.EventData.Offset)</td></tr><tr><td>ProcessExe</td><td>x=>x.EventData.ProcInfo.Exe</td></tr><tr><td>ProcessName</td><td>x=>x.EventData.ProcInfo.Name</td></tr><tr><td>RegistryPath</td><td>x=>x.EventData.RegistryPath</td></tr><tr><td>Username</td><td>x=>x.EventData.ProcInfo.Username</td></tr></tbody></table></div></div><hr><h2 id=etwwindowskernel><code>etw/windows/kernel</code>
<a class=anchor href=#etwwindowskernel>#</a></h2><p>Events from the <code>NT Kernel Logger</code> provider</p><p>The <code>NT Kernel Logger</code> ETW source is a special purpose ETW
provider that reports details about network/registry and file.</p><p>This provider enriches events with process information from the
process tracker.</p><p>This provider is special: Enabling this provider implicitly
triggers many other ETW providers such as File, Process,
Registry and Network monitoring. Velociraptor&rsquo;s ETW subsystem
recognizes the <code>Kernel Logger</code> provider automatically and
performs additional processing:</p><ul><li><p>Resolves full files paths from kernel space (uses device
notation) to regular filesystem paths (e.g. <code>C:\Windows</code>).</p></li><li><p>Collects rundown events to determine the initial system
state. This allows Velociraptor to resolve file and registry
paths from events that refer to kernel object addresses.</p></li></ul><p>For these reasons it is preferable to use this provider over
the <code>Microsoft-Windows-Kernel-File</code> or
<code>Microsoft-Windows-Kernel-Registry</code> providers.</p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Details</span></div><div class=expand-content style=display:none><h4 id=vql-query>VQL Query
<a class=anchor href=#vql-query>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> delay(
</span></span><span style=display:flex><span>  query<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>timestamp</span>(epoch<span style=color:#f92672>=</span>now()) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>Timestamp</span>,
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>System</span> <span style=color:#f92672>+</span> dict(Channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;NT-Kernel-Logger&#34;</span>,
</span></span><span style=display:flex><span>                Computer<span style=color:#f92672>=</span>Hostname,
</span></span><span style=display:flex><span>                EventType<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.KernelEventType,
</span></span><span style=display:flex><span>                EventID<span style=color:#f92672>=</span>dict(Value<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID)) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>System</span>,
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>System</span>.KernelEventType <span style=color:#66d9ef>AS</span> EventType,
</span></span><span style=display:flex><span>           EventData <span style=color:#f92672>+</span> dict(
</span></span><span style=display:flex><span>              ProcInfo<span style=color:#f92672>=</span>GetProcInfo(PID<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ProcessID)
</span></span><span style=display:flex><span>           ) <span style=color:#66d9ef>AS</span> EventData
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> watch_etw(guid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{9E814AAD-3204-11D2-9A82-006008A86939}&#39;</span>,
</span></span><span style=display:flex><span>                   capture_state<span style=color:#f92672>=</span><span style=color:#66d9ef>TRUE</span>,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>level</span><span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>                   description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;NT-Kernel-Logger&#34;</span>,
</span></span><span style=display:flex><span>                   kernel_tracer_type<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;registry&#34;</span>, <span style=color:#e6db74>&#34;process&#34;</span>, <span style=color:#e6db74>&#34;network&#34;</span>, <span style=color:#e6db74>&#34;driver&#34;</span>, <span style=color:#e6db74>&#34;file&#34;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> EventType
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>, delay<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h4 id=sample-events>Sample Events
<a class=anchor href=#sample-events>#</a></h4><h5 id=writefile>WriteFile
<a class=anchor href=#writefile>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:13:08Z","EventType":"WriteFile","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"WriteFile","EventID":{"Value":0}},"EventData":{"Offset":"450608","IrpPtr":"0xFFFF8203632DFB48","FileObject":"0xFFFF82036AFDE270","FileKey":"0xFFFFB189591D4700","TTID":"11240", "IoSize":"318","IoFlags":"395776","FileName":"C:\\datastore\\clients\\C.34365d02e4e1aa77\\monitoring_logs\\Windows.ETW.KernelFile\\2025-01-30.json","ProcInfo":{"Name":"velociraptor.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\velociraptor.exe","CommandLine":"c:\\velociraptor.exe  gui --datastore c:\\datastore\\ --nobrowser --debug -v"}}}

</pre><h5 id=readfile>ReadFile
<a class=anchor href=#readfile>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:13:08Z","EventType":"ReadFile","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"ReadFile","EventID":{"Value":0}},"EventData":{"Offset":"0","IrpPtr":"0xFFFF82036378AB48","FileObject":"0xFFFF82036AFDE270","FileKey":"0xFFFFB189591D4700","TTID":"11240","IoSize":"2","IoFlags":"0","FileName":"C:\\datastore\\clients\\C.34365d02e4e1aa77\\monitoring_logs\\Windows.ETW.KernelFile\\2025-01-30.json","ProcInfo":{"Name":"velociraptor.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\velociraptor.exe","CommandLine":"c:\\velociraptor.exe  gui --datastore c:\\datastore\\ --nobrowser --debug -v"}}}

</pre><h5 id=closefile>CloseFile
<a class=anchor href=#closefile>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:13:08Z","EventType":"CloseFile","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"CloseFile","EventID":{"Value":0}},"EventData":{"IrpPtr":"0xFFFF82036378AB48","FileObject":"0xFFFF82035B7263B0","FileKey":"0xFFFFB189591D4700","TTID":"11240","FileName":"C:\\datastore\\clients\\C.34365d02e4e1aa77\\monitoring_logs\\Windows.ETW.KernelFile\\2025-01-30.json","ProcInfo":{"Name":"velociraptor.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\velociraptor.exe","CommandLine":"c:\\velociraptor.exe  gui --datastore c:\\datastore\\ --nobrowser --debug -v"}}}

</pre><h5 id=releasefile>ReleaseFile
<a class=anchor href=#releasefile>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:06:21Z","EventType":"ReleaseFile","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"ReleaseFile","EventID":{"Value":0}},"EventData":{"IrpPtr":"0xFFFF8203597030F8","FileObject":"0xFFFF820378327250","FileKey":"0xFFFFB1893BC871B0","TTID":"4928","FileName":"C:\\datastore\\1\\VelociraptorClient_info.log.202501270000","ProcInfo":{"Name":"velociraptor.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\velociraptor.exe","CommandLine":"c:\\velociraptor.exe  gui --datastore c:\\datastore\\ --nobrowser --debug -v"}}}

</pre><h5 id=createfile>CreateFile
<a class=anchor href=#createfile>#</a></h5><pre class=json-renderer>
{
    "Timestamp": "2025-02-10T14:53:28Z",
    "EventType": "CreateFile",
    "System": {
        "Channel": "NT-Kernel-Logger",
        "Computer": "Hostname",
        "EventType": "CreateFile",
        "EventID": {
            "Value": 0
        }
    },
    "EventData": {
        "IrpPtr": "0xFFFFBB0CCAF9D0F8",
        "FileObject": "0xFFFFBB0CCED8D220",
        "TTID": "6772",
        "CreateOptions": "21119008",
        "FileAttributes": "0",
        "ShareAccess": "7",
        "OpenPath": "C:\\Windows\\System32\\psapi.dll",
        "ProcInfo": {
            "Pid": 3896,
            "Ppid": 1160,
            "Name": "MsMpEng.exe",
            "Threads": 86,
            "Username": "NT AUTHORITY\\SYSTEM",
            "OwnerSid": "S-1-5-18",
            "CommandLine": "\"C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\4.18.24090.11-0\\MsMpEng.exe\"",
            "Exe": "C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\4.18.24090.11-0\\MsMpEng.exe",
            "TokenIsElevated": true,
            "CreateTime": "2025-02-09T12:57:23.9023563Z",
            "User": 343.9949132,
            "System": 2.9596658,
            "IoCounters": {
                "ReadOperationCount": 267063,
                "WriteOperationCount": 78945,
                "OtherOperationCount": 3306593,
                "ReadTransferCount": 7729991705,
                "WriteTransferCount": 793027416,
                "OtherTransferCount": 843561371
            },
            "Memory": {
                "PageFaultCount": 108663785,
                "PeakWorkingSetSize": 998694912,
                "WorkingSetSize": 209084416,
                "QuotaPeakPagedPoolUsage": 1543600,
                "QuotaPagedPoolUsage": 698424,
                "QuotaPeakNonPagedPoolUsage": 535768,
                "QuotaNonPagedPoolUsage": 254496,
                "PagefileUsage": 331485184,
                "PeakPagefileUsage": 1064894464
            },
            "PebBaseAddress": 513193275392,
            "IsWow64": false
        }
    }
}

</pre><h5 id=regqueryvalue>RegQueryValue
<a class=anchor href=#regqueryvalue>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:06:21Z","EventType":"RegQueryValue","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"RegQueryValue","EventID":{"Value":0}},"EventData":{"InitialTime":"4597740950432","Status":"0","Index":"1","KeyHandle":"0xFFFFB189314B9200","KeyName":"StandardName","RegistryPath":"\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Control\\TimeZoneInformation\\StandardName","ProcInfo":{"Name":"velociraptor.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\velociraptor.exe","CommandLine":"c:\\velociraptor.exe  gui --datastore c:\\datastore\\ --nobrowser --debug -v"}}}

</pre><h5 id=regopenkey>RegOpenKey
<a class=anchor href=#regopenkey>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:06:28Z","EventType":"RegOpenKey","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"RegOpenKey","EventID":{"Value":0}},"EventData":{"InitialTime":"4597800728147","Status":"0","Index":"0","KeyHandle":"0xFFFFB1892A2E3050","KeyName":"SOFTWARE\\Microsoft\\Ole\\Extensions","RegistryPath":"\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Ole\\Extensions","ProcInfo":{"Name":"chrome.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe","CommandLine":"\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" "}}}

</pre><h5 id=regclosekey>RegCloseKey
<a class=anchor href=#regclosekey>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:06:28Z","EventType":"RegCloseKey","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"RegCloseKey","EventID":{"Value":0}},"EventData":{"InitialTime":"4597800729177","Status":"0","Index":"0","KeyHandle":"0xFFFFB18933C408B0","KeyName":"","RegistryPath":"\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Ole\\Extensions","ProcInfo":{"Name":"chrome.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe","CommandLine":"\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" "}}}

</pre><h5 id=regcreatekey>RegCreateKey
<a class=anchor href=#regcreatekey>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:06:36Z","EventType":"RegCreateKey","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"RegCreateKey","EventID":{"Value":0}},"EventData":{"InitialTime":"4597827001762","Status":"0","Index":"0","KeyHandle":"0xFFFFB189314C06D0","KeyName":"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections","RegistryPath":"\\REGISTRY\\USER\\S-1-5-21-241402409-3571345782-2557608070-500\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections","ProcInfo":{"Name":"chrome.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe","CommandLine":"\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" "}}}

</pre><h5 id=sendtcpv4>SendTCPv4
<a class=anchor href=#sendtcpv4>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:06:22Z","EventType":"SendTCPv4","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"SendTCPv4","EventID":{"Value":0}},"EventData":{"PID":"1596","size":"1652","daddr":"192.168.1.5","saddr":"192.168.1.237","dport":"37890","sport":"3389","startime":"45977585","endtime":"45977585","seqnum":"0","connid":null,"ProcInfo":null}}

</pre><h5 id=recvtcpv4>RecvTCPv4
<a class=anchor href=#recvtcpv4>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T14:06:22Z","EventType":"RecvTCPv4","System":{"Channel":"NT Kernel Logger","Computer":"WIN-SJE0CKQO83P","EventType":"RecvTCPv4","EventID":{"Value":0}},"EventData":{"PID":"1596","size":"74","daddr":"192.168.1.5","saddr":"192.168.1.237","dport":"37890","sport":"3389","seqnum":"0","connid":null,"ProcInfo":null}}

</pre><h5 id=createprocess>CreateProcess
<a class=anchor href=#createprocess>#</a></h5><pre class=json-renderer>
{
    "Timestamp": "2025-01-30T13:59:46Z",
    "EventType": "CreateProcess",
    "System": {
        "Channel": "NT Kernel Logger",
        "Computer": "WIN-SJE0CKQO83P",
        "EventType": "CreateProcess",
        "EventID": {
            "Value": 0
        }
    },
    "EventData": {
        "UniqueProcessKey": "0xFFFF82035F210380",
        "ProcessId": "0x1C5C",
        "ParentId": "0x524",
        "SessionId": "0",
        "ExitStatus": "259",
        "DirectoryTableBase": "0x1050BD000",
        "Flags": "0",
        "UserSID": "\\\\NT AUTHORITY\\SYSTEM",
        "ImageFileName": "WmiPrvSE.exe",
        "CommandLine": "C:\\Windows\\system32\\wbem\\wmiprvse.exe -Embedding",
        "PackageFullName": "",
        "ApplicationId": "",
        "ProcInfo": {
            "Pid": 1316,
            "Ppid": 1172,
            "Name": "svchost.exe",
            "Threads": 14,
            "Username": "NT AUTHORITY\\SYSTEM",
            "OwnerSid": "S-1-5-18",
            "CommandLine": "C:\\Windows\\system32\\svchost.exe -k DcomLaunch -p",
            "Exe": "C:\\Windows\\System32\\svchost.exe",
            "TokenIsElevated": true,
            "CreateTime": "2025-01-03T15:14:38.8669202Z",
            "User": 5.859375,
            "System": 14.65625,
            "IoCounters": {
                "ReadOperationCount": 12,
                "WriteOperationCount": 0,
                "OtherOperationCount": 161602,
                "ReadTransferCount": 49152,
                "WriteTransferCount": 0,
                "OtherTransferCount": 4860956
            },
            "Memory": {
                "PageFaultCount": 72766,
                "PeakWorkingSetSize": 27328512,
                "WorkingSetSize": 25452544,
                "QuotaPeakPagedPoolUsage": 743528,
                "QuotaPagedPoolUsage": 743288,
                "QuotaPeakNonPagedPoolUsage": 37128,
                "QuotaNonPagedPoolUsage": 21304,
                "PagefileUsage": 8261632,
                "PeakPagefileUsage": 8978432
            },
            "PebBaseAddress": 93408378880,
            "IsWow64": false
        }
    }
}

</pre><h4 id=sample-use-in-a-sigma-rule>Sample use in a sigma rule:
<a class=anchor href=#sample-use-in-a-sigma-rule>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>logsource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>category</span>: <span style=color:#ae81ff>etw</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>kernel</span>
</span></span></code></pre></div></div></div><h2 id=etwwindowsfile><code>etw/windows/file</code>
<a class=anchor href=#etwwindowsfile>#</a></h2><p>Log source based on the <code>Microsoft-Windows-Kernel-File</code> provider.</p><p>See <code>etw/windows/kernel</code> for a better ETW provider.</p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Details</span></div><div class=expand-content style=display:none><h4 id=vql-query>VQL Query
<a class=anchor href=#vql-query>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>timestamp</span>(epoch<span style=color:#f92672>=</span>now()) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>Timestamp</span>,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>System</span> <span style=color:#f92672>+</span> dict(Channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Kernel-File&#34;</span>,
</span></span><span style=display:flex><span>            Computer<span style=color:#f92672>=</span>Hostname,
</span></span><span style=display:flex><span>            EventType<span style=color:#f92672>=</span><span style=color:#66d9ef>get</span>(item<span style=color:#f92672>=</span>WindowsKernelFile_EIDLookup,
</span></span><span style=display:flex><span>                          field<span style=color:#f92672>=</span>str(str<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID)),
</span></span><span style=display:flex><span>            EventID<span style=color:#f92672>=</span>dict(Value<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID)) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>System</span>,
</span></span><span style=display:flex><span>       EventData <span style=color:#f92672>+</span> dict(
</span></span><span style=display:flex><span>           ProcInfo<span style=color:#f92672>=</span>GetProcInfo(PID<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ProcessID)
</span></span><span style=display:flex><span>       ) <span style=color:#66d9ef>AS</span> EventData
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> delay(query<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> watch_etw(
</span></span><span style=display:flex><span>      guid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{edd08927-9cc4-4e65-b970-c2560fb5c289}&#39;</span>,
</span></span><span style=display:flex><span>      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Kernel-File&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>any</span><span style=color:#f92672>=</span>WindowsKernelFile_Keyword)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>, delay<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h4 id=sample-events>Sample Events
<a class=anchor href=#sample-events>#</a></h4><h5 id=fileopen-event>FileOpen Event
<a class=anchor href=#fileopen-event>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T07:33:12Z","System":{"Channel":"Microsoft-Windows-Kernel-File","Computer":"WIN-SJE0CKQO83P","EventType":"FileOpen","EventID":{"Value":12}},"EventData":{"Irp":"0xFFFF8203746EAB08","FileObject":"0xFFFF8203783249B0","IssuingThreadId":"8924","CreateOptions":"0x1200000","CreateAttributes":"0x0","ShareAccess":"0x7","FileName":"\\Device\\HarddiskVolume3\\datastore\\1\\VelociraptorClient_info.log.202501270000","ProcInfo":{"Name":"velociraptor.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\velociraptor.exe","CommandLine":"c:\\velociraptor.exe  gui --datastore c:\\datastore\\ --nobrowser --debug -v"}}}

</pre><h5 id=createnewfile-event>CreateNewFile Event
<a class=anchor href=#createnewfile-event>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T07:33:07Z","System":{"Channel":"Microsoft-Windows-Kernel-File","Computer":"WIN-SJE0CKQO83P","EventType":"CreateNewFile","EventID":{"Value":30}},"EventData":{"Irp":"0xFFFF82035D7F9C88","FileObject":"0xFFFF82035D145A80","IssuingThreadId":"8096","CreateOptions":"0x5000060","CreateAttributes":"0x80","ShareAccess":"0x3","FileName":"\\Device\\HarddiskVolume3\\datastore\\hunts\\H.CUDEISQSB5K60\\notebook\\N.H.CUDEISQSB5K60\\NC.CUDIKP2J653IQ-CUDIMC0CRIMHS.json.db","ProcInfo":{"Name":"velociraptor.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\velociraptor.exe","CommandLine":"c:\\velociraptor.exe  gui --datastore c:\\datastore\\ --nobrowser --debug -v"}}}

</pre><h5 id=namecreate-event>NameCreate Event
<a class=anchor href=#namecreate-event>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T07:33:07Z","System":{"Channel":"Microsoft-Windows-Kernel-File","Computer":"WIN-SJE0CKQO83P","EventType":"NameCreate","EventID":{"Value":10}},"EventData":{"FileKey":"0xFFFFB18937D871B0","FileName":"\\Device\\HarddiskVolume3\\datastore\\hunts\\H.CUDEISQSB5K60\\notebook\\N.H.CUDEISQSB5K60\\NC.CUDIKP2J653IQ-CUDIMC0CRIMHS.json.db","ProcInfo":{"Name":"velociraptor.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\velociraptor.exe","CommandLine":"c:\\velociraptor.exe  gui --datastore c:\\datastore\\ --nobrowser --debug -v"}}}

</pre><h4 id=sample-use-in-a-sigma-rule>Sample use in a sigma rule:
<a class=anchor href=#sample-use-in-a-sigma-rule>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>logsource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>category</span>: <span style=color:#ae81ff>etw</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>file</span>
</span></span></code></pre></div></div></div><h2 id=etwwindowsregistry><code>etw/windows/registry</code>
<a class=anchor href=#etwwindowsregistry>#</a></h2><p>Log source based on the <code>Microsoft-Windows-Kernel-Registry</code> provider.</p><p>See <code>etw/windows/kernel</code> for a better ETW provider.</p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Details</span></div><div class=expand-content style=display:none><h4 id=vql-query>VQL Query
<a class=anchor href=#vql-query>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>timestamp</span>(epoch<span style=color:#f92672>=</span>now()) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>Timestamp</span>,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>System</span> <span style=color:#f92672>+</span> dict(Channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Kernel-Registry&#34;</span>,
</span></span><span style=display:flex><span>            Computer<span style=color:#f92672>=</span>Hostname,
</span></span><span style=display:flex><span>            EventType<span style=color:#f92672>=</span><span style=color:#66d9ef>get</span>(item<span style=color:#f92672>=</span>WindowsKernelRegistry_EIDLookup,
</span></span><span style=display:flex><span>                          field<span style=color:#f92672>=</span>str(str<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID)),
</span></span><span style=display:flex><span>            EventID<span style=color:#f92672>=</span>dict(Value<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID)) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>System</span>,
</span></span><span style=display:flex><span>       EventData <span style=color:#f92672>+</span> dict(
</span></span><span style=display:flex><span>           ProcInfo<span style=color:#f92672>=</span>GetProcInfo(PID<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ProcessID)
</span></span><span style=display:flex><span>       ) <span style=color:#66d9ef>AS</span> EventData
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> delay(query<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> watch_etw(
</span></span><span style=display:flex><span>      guid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{70eb4f03-c1de-4f73-a051-33d13d5413bd}&#39;</span>,
</span></span><span style=display:flex><span>      capture_state<span style=color:#f92672>=</span><span style=color:#66d9ef>TRUE</span>,
</span></span><span style=display:flex><span>      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Kernel-Registry&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>any</span><span style=color:#f92672>=</span>WindowsKernelRegistry_Keyword)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>, delay<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h4 id=sample-events>Sample Events
<a class=anchor href=#sample-events>#</a></h4><h5 id=createkey-event>CreateKey Event
<a class=anchor href=#createkey-event>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T08:10:20Z","System":{"Channel":"Microsoft-Windows-Kernel-Registry","Computer":"WIN-SJE0CKQO83P","EventType":"CreateKey","EventID":{"Value":1}},"EventData":{"BaseObject":"0xFFFFB1893D043AA0","KeyObject":"0x0","Status":"0x104","Disposition":"0","BaseName":"","RelativeName":"\\REGISTRY\\USER\\S-1-5-21-241402409-3571345782-2557608070-500_Classes\\Local Settings\\Software\\Microsoft\\Windows\\CurrentVersion\\AppModel\\SystemAppData\\Microsoft.Windows.StartMenuExperienceHost_cw5n1h2txyewy","ProcInfo":null,"ParentProcInfo":{"Name":"svchost.exe","Username":"NT AUTHORITY\\SYSTEM","Exe":"C:\\Windows\\System32\\svchost.exe","CommandLine":"C:\\Windows\\system32\\svchost.exe -k DcomLaunch -p"}}}

</pre><h5 id=deletekey-event>DeleteKey Event
<a class=anchor href=#deletekey-event>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T08:12:50Z","System":{"Channel":"Microsoft-Windows-Kernel-Registry","Computer":"WIN-SJE0CKQO83P","EventType":"DeleteKey","EventID":{"Value":3}},"EventData":{"KeyObject":"0xFFFFB189385B9BB0","Status":"0x0","KeyName":"","ProcInfo":null,"ParentProcInfo":{"Name":"regedit.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\Windows\\regedit.exe","CommandLine":"\"C:\\Windows\\regedit.exe\" "}}}

</pre><h5 id=deletevaluekey-event>DeleteValueKey Event
<a class=anchor href=#deletevaluekey-event>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T08:12:33Z","System":{"Channel":"Microsoft-Windows-Kernel-Registry","Computer":"WIN-SJE0CKQO83P","EventType":"DeleteValueKey","EventID":{"Value":6}},"EventData":{"KeyObject":"0xFFFFB1893D0460E0","Status":"0xC0000034","KeyName":"","ValueName":"CachedFeatureString","ProcInfo":null,"ParentProcInfo":{"Name":"SearchApp.exe","Username":"WIN-SJE0CKQO83P\\Administrator","Exe":"C:\\Windows\\SystemApps\\Microsoft.Windows.Search_cw5n1h2txyewy\\SearchApp.exe","CommandLine":"\"C:\\Windows\\SystemApps\\Microsoft.Windows.Search_cw5n1h2txyewy\\SearchApp.exe\" -ServerName:CortanaUI.AppX8z9r6jm96hw4bsbneegw0kyxx296wr9t.mca"}}}

</pre><h5 id=openkey-event>OpenKey Event
<a class=anchor href=#openkey-event>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T08:08:51Z","System":{"Channel":"Microsoft-Windows-Kernel-Registry","Computer":"WIN-SJE0CKQO83P","EventType":"OpenKey","EventID":{"Value":2}},"EventData":{"BaseObject":"0xFFFFB1892A262AD0","KeyObject":"0xFFFFB1893C344100","Status":"0x0","Disposition":"0","BaseName":"","RelativeName":"\\Registry\\Machine\\Hardware\\DeviceMap\\VIDEO","ProcInfo":null,"ParentProcInfo":{"Name":"vm3dservice.exe","Username":"NT AUTHORITY\\SYSTEM","Exe":"C:\\Windows\\System32\\vm3dservice.exe","CommandLine":"vm3dservice.exe -n"}}}

</pre><h5 id=setvaluekey-event>SetValueKey Event
<a class=anchor href=#setvaluekey-event>#</a></h5><pre class=json-renderer>
{"Timestamp":"2025-01-30T08:10:20Z","System":{"Channel":"Microsoft-Windows-Kernel-Registry","Computer":"WIN-SJE0CKQO83P","EventType":"SetValueKey","EventID":{"Value":5}},"EventData":{"KeyObject":"0xFFFFB1893D043AA0","Status":"0x0","Type":"11","DataSize":"8","KeyName":"","ValueName":"PCT","CapturedDataSize":"0","CapturedData":"","PreviousDataType":"0","PreviousDataSize":"0","PreviousDataCapturedSize":"0","PreviousData":null,"ProcInfo":null,"ParentProcInfo":{"Name":"svchost.exe","Username":"NT AUTHORITY\\SYSTEM","Exe":"C:\\Windows\\System32\\svchost.exe","CommandLine":"C:\\Windows\\system32\\svchost.exe -k DcomLaunch -p"}}}

</pre><h4 id=sample-use-in-a-sigma-rule>Sample use in a sigma rule:
<a class=anchor href=#sample-use-in-a-sigma-rule>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>logsource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>category</span>: <span style=color:#ae81ff>etw</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>registry</span>
</span></span></code></pre></div></div></div><h2 id=etwwindowsprocess><code>etw/windows/process</code>
<a class=anchor href=#etwwindowsprocess>#</a></h2><p>Log source based on the <code>Microsoft-Windows-Kernel-Registry</code> provider</p><p>See <code>etw/windows/kernel</code> for a better ETW provider.</p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Details</span></div><div class=expand-content style=display:none><h4 id=vql-query>VQL Query
<a class=anchor href=#vql-query>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>timestamp</span>(epoch<span style=color:#f92672>=</span>now()) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>Timestamp</span>,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>System</span> <span style=color:#f92672>+</span> dict(Channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Kernel-Process&#34;</span>,
</span></span><span style=display:flex><span>            Computer<span style=color:#f92672>=</span>Hostname,
</span></span><span style=display:flex><span>            EventType<span style=color:#f92672>=</span><span style=color:#66d9ef>get</span>(item<span style=color:#f92672>=</span>WindowsKernelProcess_EIDLookup,
</span></span><span style=display:flex><span>                          field<span style=color:#f92672>=</span>str(str<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID)),
</span></span><span style=display:flex><span>            EventID<span style=color:#f92672>=</span>dict(Value<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID)) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>System</span>,
</span></span><span style=display:flex><span>       EventData <span style=color:#f92672>+</span> dict(
</span></span><span style=display:flex><span>          ProcInfo<span style=color:#f92672>=</span>GetProcInfo(PID<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ProcessID)
</span></span><span style=display:flex><span>       ) <span style=color:#66d9ef>AS</span> EventData
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> delay(query<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> watch_etw(
</span></span><span style=display:flex><span>      guid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{22fb2cd6-0e7b-422b-a0c7-2fad1fd0e716}&#39;</span>,
</span></span><span style=display:flex><span>      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Kernel-Process&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>any</span><span style=color:#f92672>=</span>WindowsKernelProcess_Keyword)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>, delay<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h4 id=sample-use-in-a-sigma-rule>Sample use in a sigma rule:
<a class=anchor href=#sample-use-in-a-sigma-rule>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>logsource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>category</span>: <span style=color:#ae81ff>etw</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>process</span>
</span></span></code></pre></div></div></div><h2 id=etwwindowssysmon><code>etw/windows/sysmon</code>
<a class=anchor href=#etwwindowssysmon>#</a></h2><p>Log source to read Sysmon events via ETW</p><p>This is better than reading the log files since it does not use
the event log service.</p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Details</span></div><div class=expand-content style=display:none><h4 id=vql-query>VQL Query
<a class=anchor href=#vql-query>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> delay(query<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>System</span>.<span style=color:#66d9ef>TimeStamp</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>Timestamp</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>System</span> <span style=color:#f92672>+</span> dict(
</span></span><span style=display:flex><span>       EventId<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID,
</span></span><span style=display:flex><span>       Computer<span style=color:#f92672>=</span>Hostname,
</span></span><span style=display:flex><span>       Channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Sysmon/Operational&#34;</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>System</span>,
</span></span><span style=display:flex><span>    EventData <span style=color:#f92672>+</span> dict(ProcInfo<span style=color:#f92672>=</span>process_tracker_get(
</span></span><span style=display:flex><span>       id<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ProcessID).<span style=color:#66d9ef>Data</span>) <span style=color:#66d9ef>AS</span> EventData
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> watch_etw(
</span></span><span style=display:flex><span>      guid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{5770385f-c22a-43e0-bf4c-06f5698ffbd9}&#39;</span>,
</span></span><span style=display:flex><span>      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Sysmon/Operational&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>, delay<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h4 id=sample-use-in-a-sigma-rule>Sample use in a sigma rule:
<a class=anchor href=#sample-use-in-a-sigma-rule>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>logsource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>category</span>: <span style=color:#ae81ff>etw</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>sysmon</span>
</span></span></code></pre></div></div></div><h2 id=etwwindowsetw><code>etw/windows/etw</code>
<a class=anchor href=#etwwindowsetw>#</a></h2><p>Log source to monitor ETW system states</p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Details</span></div><div class=expand-content style=display:none><h4 id=vql-query>VQL Query
<a class=anchor href=#vql-query>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> delay(query<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>System</span>.<span style=color:#66d9ef>TimeStamp</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>Timestamp</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>System</span> <span style=color:#f92672>+</span> dict(
</span></span><span style=display:flex><span>       EventId<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID,
</span></span><span style=display:flex><span>       Computer<span style=color:#f92672>=</span>Hostname,
</span></span><span style=display:flex><span>       Channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Kernel-EventTracing&#34;</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>System</span>,
</span></span><span style=display:flex><span>    EventData <span style=color:#f92672>+</span> dict(ProcInfo<span style=color:#f92672>=</span>process_tracker_get(
</span></span><span style=display:flex><span>       id<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ProcessID).<span style=color:#66d9ef>Data</span>) <span style=color:#66d9ef>AS</span> EventData
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> watch_etw(
</span></span><span style=display:flex><span>      guid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{B675EC37-BDB6-4648-BC92-F3FDC74D3CA2}&#39;</span>, <span style=color:#66d9ef>any</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x30,
</span></span><span style=display:flex><span>      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Kernel-EventTracing&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>, delay<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h4 id=sample-use-in-a-sigma-rule>Sample use in a sigma rule:
<a class=anchor href=#sample-use-in-a-sigma-rule>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>logsource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>category</span>: <span style=color:#ae81ff>etw</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>etw</span>
</span></span></code></pre></div></div></div><h2 id=etwwindowswmi><code>etw/windows/wmi</code>
<a class=anchor href=#etwwindowswmi>#</a></h2><p>Log source to monitor WMI activity</p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Details</span></div><div class=expand-content style=display:none><h4 id=vql-query>VQL Query
<a class=anchor href=#vql-query>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> delay(query<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>System</span>.<span style=color:#66d9ef>TimeStamp</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>Timestamp</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>System</span> <span style=color:#f92672>+</span> dict(
</span></span><span style=display:flex><span>       EventId<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID,
</span></span><span style=display:flex><span>       Computer<span style=color:#f92672>=</span>Hostname,
</span></span><span style=display:flex><span>       Channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-WMI-Activity&#34;</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>System</span>,
</span></span><span style=display:flex><span>    EventData <span style=color:#f92672>+</span> dict(ProcInfo<span style=color:#f92672>=</span>process_tracker_get(
</span></span><span style=display:flex><span>       id<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ProcessID).<span style=color:#66d9ef>Data</span>) <span style=color:#66d9ef>AS</span> EventData
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> watch_etw(
</span></span><span style=display:flex><span>      guid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{1418EF04-B0B4-4623-BF7E-D74AB47BBDAA}&#39;</span>, <span style=color:#66d9ef>any</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x30,
</span></span><span style=display:flex><span>      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-WMI-Activity&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>, delay<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h4 id=sample-use-in-a-sigma-rule>Sample use in a sigma rule:
<a class=anchor href=#sample-use-in-a-sigma-rule>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>logsource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>category</span>: <span style=color:#ae81ff>etw</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>wmi</span>
</span></span></code></pre></div></div></div><h2 id=etwwindowsdns><code>etw/windows/dns</code>
<a class=anchor href=#etwwindowsdns>#</a></h2><p>Log source to monitor DNS Lookups</p><p>See full description <a href=https://github.com/repnz/etw-providers-docs/blob/master/Manifests-Win10-18990/Microsoft-Windows-DNS-Client.xml>here</a></p><div class=expand><div class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(100,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Details</span></div><div class=expand-content style=display:none><h4 id=vql-query>VQL Query
<a class=anchor href=#vql-query>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> delay(query<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>System</span>.<span style=color:#66d9ef>TimeStamp</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>Timestamp</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>System</span> <span style=color:#f92672>+</span> dict(
</span></span><span style=display:flex><span>       EventId<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ID,
</span></span><span style=display:flex><span>       Computer<span style=color:#f92672>=</span>Hostname,
</span></span><span style=display:flex><span>       Channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-DNS-Client&#34;</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>System</span>,
</span></span><span style=display:flex><span>    EventData <span style=color:#f92672>+</span> dict(ProcInfo<span style=color:#f92672>=</span>process_tracker_get(
</span></span><span style=display:flex><span>       id<span style=color:#f92672>=</span><span style=color:#66d9ef>System</span>.ProcessID).<span style=color:#66d9ef>Data</span>) <span style=color:#66d9ef>AS</span> EventData
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> watch_etw(
</span></span><span style=display:flex><span>      guid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{1C95126E-7EEA-49A9-A3FE-A378B03DDB4D}&#39;</span>, <span style=color:#66d9ef>any</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x30,
</span></span><span style=display:flex><span>      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft-Windows-DNS-Client&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>, delay<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h4 id=sample-use-in-a-sigma-rule>Sample use in a sigma rule:
<a class=anchor href=#sample-use-in-a-sigma-rule>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>logsource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>category</span>: <span style=color:#ae81ff>etw</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>dns</span>
</span></span></code></pre></div></div></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main></body></html>